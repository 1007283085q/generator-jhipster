/**
 * This the grammar we use to generate the parser jhGrammar.js.
 * We use the online tool http://pegjs.org/online to generate the parser.
 * Modifying this file won't affect the program, this is just to have a more readable grammar.
 */

{
  function addUniqueElements(array1, array2) {
    if (array2) {
      for (let i = 0; i < array2.length; i++) {
        if (array1.indexOf(array2[i]) === -1) {
          array1.push(array2[i]);
        }
      }
    }
    return array1;
  }

  function flattenArray(array) {
    var newArray = [];
    for (let i = 0; i < array.length; i ++) {
      if (!array[i].length) {
        newArray.push(array[i]);
      } else {
        for (let j = 0; j < array[i].length; j++) {
          newArray.push(array[i][j]);
        }
      }
    }
    return newArray;
  }

  function addCardinalityToRelationships(cardinality, relationships) {
    if (!relationships) {
      return;
    }
    for (let i = 0; i < relationships.length; i++) {
      relationships[i].cardinality = cardinality;
    }
  }

  const entities = [];
  const relationships = [];
  const enums = [];
  const dto = {};
  const pagination = {};
  const service = {};
  const microservice = {};
  const searchEngine = {};
  const noClient = { list: [], excluded: [] };
  const noServer = { list: [], excluded: [] };
  const angularSuffix = {};
  const noFluentMethod = { list: [], excluded: [] };
}

start = p:prog { return p; }

prog
  = SPACE* ed:entityDecl SPACE* p:prog {return {entities: addUniqueElements([ed],p.entities) , relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* rd:relationDecl SPACE* p:prog {return {entities: p.entities, relationships: flattenArray(addUniqueElements([rd],p.relationships)), enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* end:enumDecl SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: addUniqueElements([end], p.enums), dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* dto:dtoDecl SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* pagination:pagiDecl SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* service:serviceDecl SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* comment SPACE* p:prog {return {entities: p.entities,relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* JDLComment SPACE* p:prog {return {entities: p.entities,relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* microservice:microserviceDecl1 SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* searchEngine:searchEngineDecl SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* noClient:noClientDecl SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* noServer:noServerDecl SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* angularSuffix:angularSuffixDecl SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / SPACE* noFluentMethod:noFluentMethod SPACE* p:prog {return {entities: p.entities, relationships: p.relationships, enums: p.enums, dto: p.dto, pagination: p.pagination, service: service, microservice: microservice, searchEngine: searchEngine, noClient: noClient, noServer: noServer, angularSuffix: angularSuffix, noFluentMethod: noFluentMethod};}
  / '' {
    return {
      entities: entities,
      relationships: relationships,
      enums: enums,
      dto: dto,
      pagination: pagination,
      service: service,
      microservice: microservice,
      searchEngine: searchEngine,
      noClient: noClient,
      noServer: noServer,
      angularSuffix: angularSuffix,
      noFluentMethod: noFluentMethod};
    }

//Entities
entityDecl
  = jd:comment? SPACE* JDLComment? SPACE* ENTITY SPACE* e:ENTITY_NAME SPACE* tableName:entityTableNameDecl? SPACE* eb:entityBody? SPACE* JDLComment? {
    return { name: e, tableName: tableName ? tableName: e, body: eb, javadoc: jd };
  }
  / ENTITY SPACE* e:ENTITY_NAME SPACE* eb:entityBody? { return { name: e, body: eb, javadoc: '' }; }

entityTableNameDecl
  = '(' SPACE* name:[A-z0-9_-]+ SPACE* ')' { return name.join(''); }

entityBody
  = '{' SPACE* JDLComment? SPACE* fdl:fieldDeclList SPACE* JDLComment? SPACE* '}' { return fdl; }
  / '' { return []; }

fieldDeclList
  = JDLComment? SPACE* com:comment? SPACE* JDLComment? SPACE* f:FIELD_NAME SPACE t:type SPACE* vl:validationList? SPACE* com2:comment? SPACE* ','? SPACE* JDLComment? SPACE* fdl:fieldDeclList {
    return addUniqueElements([{ name: f, type: t, validations: vl, javadoc: com || com2 }], fdl );
  }
  / com:comment? SPACE* f:FIELD_NAME SPACE t:type SPACE* vl:validationList {
    return [{ name: f, type: t, validations: vl, javadoc: com }];
  }
  / '' { return []; }

validationList
  = v:validation SPACE* vl:validationList { return addUniqueElements([v], vl); }
  / '' { return []; }

//Relationship
relationDecl
  = RELATIONSHIP SPACE rt:relationshipType SPACE* '{' SPACE* JDLComment? SPACE* bodies:relationshipBodies SPACE* JDLComment? SPACE* '}' {
        addCardinalityToRelationships(rt, bodies);
        return addUniqueElements([], bodies);
    }

relationshipBodies
  = rb:relationshipBody SPACE* ',' SPACE* morerb:relationshipBodies { return addUniqueElements([rb], morerb); }
  / rb:relationshipBody { return [rb]; }

relationshipBody
  = from:relationshipSide SPACE* JDLComment? SPACE* 'to' SPACE* JDLComment? SPACE* to:relationshipSide SPACE* JDLComment? {
    return { from: from , to: to };
  }

relationshipSide
  = jd:comment? SPACE* e:ENTITY_NAME SPACE* '{' SPACE* i:INJECTED_FIELD_NAME SPACE* required:'required'? '}' SPACE* {
    return { name: e, injectedfield: i, javadoc: jd, required: required ? true : false };
  }
  / jd:comment? SPACE* e:ENTITY_NAME SPACE* ('{' SPACE* '}')? SPACE* {
    return { name: e, injectedfield: null, javadoc: jd };
  }
  / e:ENTITY_NAME SPACE { return { name: e, injectedfield: null, javadoc: '' }; }


//Enum
enumDecl
  = ENUM SPACE e:ENUMNAME SPACE* '{' SPACE* JDLComment? SPACE* el:enumPropList SPACE* JDLComment? SPACE* '}' {
    return { name: e, values: el };
  }

enumPropList
  = e:ENUMPROP SPACE* ',' SPACE* JDLComment? SPACE* el:enumPropList { return addUniqueElements([e], el); }
  / e:ENUMPROP { return [e]; }

exclusion
  = EXCEPT SPACE+ sub:exclusionSub { return sub; }

exclusionSub
  = e:ENTITY_NAME SPACE* ',' SPACE* sub:exclusionSub { return addUniqueElements([e], sub); }
  / e:ENTITY_NAME { return [e]; }

// noFluentMethod
noFluentMethod
  = NO_FLUENT_METHOD SPACE FOR SPACE+ decl:subNoFluentMethod SPACE* ex:exclusion? SPACE* JDLComment? {
    addUniqueElements(noFluentMethod.list, decl);
    if (ex) {
        addUniqueElements(noFluentMethod.excluded, ex);
    }
  }

subNoFluentMethod
  = e:ENTITY_NAME SPACE* ',' SPACE* sub:subNoFluentMethod { return concat([e], sub); }
  / STAR { return ['*']; }
  / ALL { return ['*']; }
  / e:ENTITY_NAME { return [e]; }

// DTO
dtoDecl
  = DTO SPACE+ decl:entityList SPACE* ex:exclusion? SPACE* JDLComment? {
    dto[decl[decl.length - 1]] = dto[decl[decl.length - 1]] || { list: [], excluded: [] };
    addUniqueElements(dto[decl[decl.length - 1]].list, decl.slice(0, decl.length - 1));
    if (ex) {
    	addUniqueElements(dto[decl[decl.length - 1]].excluded, ex);
    }
  }

// Pagination
pagiDecl
  = PAGINATE SPACE+ decl:entityList SPACE* ex:exclusion? SPACE* JDLComment? {
  	pagination[decl[decl.length - 1]] = pagination[decl[decl.length - 1]] || { list: [], excluded: [] };
    addUniqueElements(pagination[decl[decl.length - 1]].list, decl.slice(0, decl.length - 1));
    if (ex) {
    	addUniqueElements(pagination[decl[decl.length - 1]].excluded, ex);
    }
  }

// Service
serviceDecl
  = SERVICE SPACE+ decl:entityList SPACE* ex:exclusion? SPACE* JDLComment? {
  	service[decl[decl.length - 1]] = service[decl[decl.length - 1]] || { list: [], excluded: [] };
    addUniqueElements(service[decl[decl.length - 1]].list, decl.slice(0, decl.length - 1));
    if (ex) {
    	addUniqueElements(service[decl[decl.length - 1]].excluded, ex);
    }
  }

// first way of declaring microservices
microserviceDecl1
  = MICROSERVICE SPACE+ decl:entityList SPACE* ex:exclusion? SPACE* JDLComment? {
    microservice[decl[decl.length - 1]] = microservice[decl[decl.length - 1]] || { list: [], excluded: [] };
    addUniqueElements(microservice[decl[decl.length - 1]].list, decl.slice(0, decl.length - 1));
    if (ex) {
        addUniqueElements(microservice[decl[decl.length - 1]].excluded, ex);
    }
  }

// searchEngine
searchEngineDecl
  = SEARCH SPACE+ decl:entityList SPACE* ex:exclusion? SPACE* JDLComment? {
    searchEngine[decl[decl.length - 1]] = searchEngine[decl[decl.length - 1]] || { list: [], excluded: [] };
    addUniqueElements(searchEngine[decl[decl.length - 1]].list, decl.slice(0, decl.length - 1));
    if (ex) {
        addUniqueElements(searchEngine[decl[decl.length - 1]].excluded, ex);
    }
  }

// skipClient option
noClientDecl
  = SKIP_CLIENT SPACE FOR SPACE* decl:subNoClientDecl SPACE* ex:exclusion? SPACE* JDLComment? {
    addUniqueElements(noClient.list, decl);
    if (ex) {
        addUniqueElements(noClient.excluded, ex);
    }
  }

subNoClientDecl
  = e:ENTITY_NAME SPACE* ',' SPACE* sub:subNoClientDecl { return concat([e], sub); }
  / STAR { return ['*']; }
  / ALL { return ['*']; }
  / e:ENTITY_NAME { return [e]; }


// skipServer option
noServerDecl
  = SKIP_SERVER SPACE FOR SPACE* decl:subNoServerDecl SPACE* ex:exclusion? SPACE* JDLComment? {
    addUniqueElements(noServer.list, decl);
    if (ex) {
        addUniqueElements(noServer.excluded, ex);
    }
  }

subNoServerDecl
  = e:ENTITY_NAME SPACE* ',' SPACE* sub:subNoServerDecl { return concat([e], sub); }
  / STAR { return ['*']; }
  / ALL { return ['*']; }
  / e:ENTITY_NAME { return [e]; }


// angularSuffix option
angularSuffixDecl
  = ANGULAR_SUFFIX SPACE* decl:entityList SPACE* ex:exclusion? SPACE* JDLComment? {
    angularSuffix[decl[decl.length - 1]] = angularSuffix[decl[decl.length - 1]] || { list: [], excluded: [] };
    addUniqueElements(angularSuffix[decl[decl.length - 1]].list, decl.slice(0, decl.length - 1));
    if (ex) {
      addUniqueElements(angularSuffix[decl[decl.length - 1]].excluded, ex);
    }
  }

// common way to declare an entity list
entityList
  = e:ENTITY_NAME SPACE* ',' SPACE* sub:entityList { return addUniqueElements([e], sub); }
  / STAR SPACE* WITH SPACE* method:([A-z0-9-]+) { return ['*', method.toString().replace(/,/g,'')]; }
  / ALL SPACE* WITH SPACE* method:([A-z0-9-]+) { return ['*', method.toString().replace(/,/g,'')]; }
  / e:ENTITY_NAME SPACE* WITH SPACE* method:([A-z0-9-]+) { return [e, method.toString().replace(/,/g,'')]; }


relationshipType 
= ONE_TO_ONE { return 'one-to-one'; }
/ ONE_TO_MANY { return 'one-to-many'; }
/ MANY_TO_ONE { return 'many-to-one'; }
/ MANY_TO_MANY { return 'many-to-many'; }

type = head:[A-Z]tail:[A-z0-9]* { return `${head}${tail.join('')}`; }

validation
  = REQUIRED { return { key: 'required', value: '' }; }
  / MINLENGTH SPACE* '(' SPACE* int:INTEGER SPACE* ')' { return { key: 'minlength', value: int }; }
  / MAXLENGTH SPACE* '(' SPACE* int:INTEGER SPACE* ')' { return { key: 'maxlength', value: int }; }
  / MINBYTES SPACE* '(' SPACE* int:INTEGER SPACE* ')' { return { key: 'minbytes', value: int }; }
  / MAXBYTES SPACE* '(' SPACE* int:INTEGER SPACE* ')' { return { key: 'maxbytes', value: int }; }
  / MAX SPACE* '(' SPACE* int:INTEGER SPACE* ')' { return { key: 'max', value: int };}
  / MIN SPACE* '(' SPACE* int:INTEGER SPACE* ')' { return { key: 'min', value: int };}
  / PATTERN SPACE* '('  APOSTROPHE regex:REGEX APOSTROPHE SPACE* ')' { return { key: 'pattern', value: regex }; }

// Comments
comment = commentStart notAComment:notAComment* commentStop { return notAComment.join(''); }
commentStart = '/*' [*]*
commentStop = [*]+ '/'
// a completely ignored comment, will not be a Javadoc comment
JDLComment = '//' [^\n\r]*
notAComment = !commentStop !commentStart char:. { return char; }

// Constants
ENTITY = 'entity'
RELATIONSHIP = 'relationship'
ENUM = 'enum'
// Relationship types
ONE_TO_ONE = 'OneToOne'
ONE_TO_MANY = 'OneToMany'
MANY_TO_ONE = 'ManyToOne'
MANY_TO_MANY = 'ManyToMany'
// Options
ALL = 'all'
STAR = '*'
FOR = 'for'
WITH = 'with'
EXCEPT = 'except'
NO_FLUENT_METHOD = 'noFluentMethod'
DTO = 'dto'
PAGINATE = 'paginate'
SERVICE = 'service'
MICROSERVICE = 'microservice'
SEARCH = 'search'
SKIP_CLIENT = 'skipClient'
SKIP_SERVER = 'skipServer'
ANGULAR_SUFFIX = 'angularSuffix'
// validations
REQUIRED = 'required'
MINLENGTH = 'minlength'
MAXLENGTH = 'maxlength'
MINBYTES = 'minbytes'
MAXBYTES = 'maxbytes'
MAX = 'max'
MIN = 'min'
PATTERN = 'pattern'

ENUMNAME = head:[A-Z]tail:[A-z0-9]* { return `${head}${tail.join('')}`; }
ENUMPROP = underscore:[_]*head:[A-Z0-9]tail:[A-Z0-9_]* {
    return `${underscore.join('')}${head}${tail.join('')}`;
  }
INTEGER = negative:'-'?int:[0-9]+ { return parseInt(`${(negative ? negative : '') + int.join('')}`, 10); }
INJECTED_FIELD_NAME = head:[a-zA-Z]tail:[A-z0-9()]* { return `${head}${tail.join('')}`; }
ENTITY_NAME = head:[A-Z]tail:[A-z0-9]* { return `${head}${tail.join('')}`; }
FIELD_NAME = head:[a-zA-Z]tail:[A-z0-9]* { return `${head}${tail.join('')}`; }
SPACE = ['\n'|'\t'|'\r'|' '|\u2028|\u2029]
REGEX = word:[A-z0-9!@#$%^&*()_+\-=\[\]{};':\\|,.<>\/? ]* { return word.join('') }
APOSTROPHE = ["|']
