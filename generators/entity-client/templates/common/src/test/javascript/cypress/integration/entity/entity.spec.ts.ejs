import {
  entityTableSelector,
  entityCreateButtonSelector,
  entityCreateSaveButtonSelector,
  entityDetailsButtonSelector,
  entityDetailsBackButtonSelector,
  entityEditButtonSelector,
  entityDeleteButtonSelector,
  entityConfirmDeleteButtonSelector,
} from '../../support/entity';
<%_
const baseApi = (applicationType === 'gateway' && locals.microserviceName) ? microserviceName.toLowerCase() + '/api/' : 'api/';
let openBlockComment = ``;
let closeBlockComment = ``;
for (let relationship of relationships) {
  if (relationship.relationshipRequired || relationship.useJPADerivedIdentifier) {
    openBlockComment = `/* this test is commented because it contains required relationships`;
    closeBlockComment = `*/`;
    break;
  }
}
_%>

describe('<%= entityClass %> e2e test', () => {
  let startingEntitiesCount = 0;

  <%_ if (authenticationType === 'oauth2') { _%>
  beforeEach(() => {
    cy.clearCache();
    cy.keycloackLogout();
    cy.visit('/');
    cy.keycloackLogin('user');
    cy.clickOnLoginItem();
    cy.server();
    cy.route('GET', '/<%= baseApi + entityApiUrl %>*').as('entitiesRequest');
    cy.visit('');
    cy.clickOnEntityMenuItem('<%= entityStateName %>');
    cy.wait('@entitiesRequest').its('responseBody').then(array => {
      startingEntitiesCount = array.length;
    });
    cy.visit('/');
  });
  <%_ } else { _%>
  before(() => {
    cy.window().then((win) => {
      win.sessionStorage.clear()
    });
    cy.clearCookies();
    cy.server();
    cy.route('GET', '/<%= baseApi + entityApiUrl %>*').as('entitiesRequest');
    cy.visit('');
    cy.login('admin', 'admin');
    cy.clickOnEntityMenuItem('<%= entityStateName %>');
    cy.wait('@entitiesRequest').its('responseBody').then(array => {
      startingEntitiesCount = array.length;
    });
    cy.visit('/');
  });
  <%_ } _%>

  <%_ if (authenticationType === 'session') { _%>
  beforeEach(() => {
    Cypress.Cookies.preserveOnce('JSESSIONID', 'XSRF-TOKEN');
  });
  <%_ } _%>

  it('should load <%= entityClassPlural %>', () => {
    cy.server();
    cy.route('GET', '/<%= baseApi + entityApiUrl %>*').as('entitiesRequest');
    cy.visit('/');
    cy.clickOnEntityMenuItem('<%= entityStateName %>');
    cy.wait('@entitiesRequest');
    cy.getEntityHeading('<%= entityClass %>').should('exist');
    if (startingEntitiesCount === 0) {
      cy.get(entityTableSelector).should('not.exist');
    } else {
      cy.get(entityTableSelector).should('have.lengthOf', startingEntitiesCount);
    }
    cy.visit('/');
  });

  it('should load details <%= entityClass %> page', () => {
    cy.server();
    cy.route('GET', '/<%= baseApi + entityApiUrl %>*').as('entitiesRequest');
    cy.visit('/');
    cy.clickOnEntityMenuItem('<%= entityStateName %>');
    cy.wait('@entitiesRequest');
    if (startingEntitiesCount > 0) {
      cy.get(entityDetailsButtonSelector).first().click({force: true});
      cy.getEntityDetailsHeading('<%= entityInstance %>');
      cy.get(entityDetailsBackButtonSelector).should('exist');
    }
    cy.visit('/');
  });

  <%_ if (!readOnly) { _%>
  it('should load create <%= entityClass %> page', () => {
    cy.server();
    cy.route('GET', '/<%= baseApi + entityApiUrl %>*').as('entitiesRequest');
    cy.visit('/');
    cy.clickOnEntityMenuItem('<%= entityStateName %>');
    cy.wait('@entitiesRequest');
    cy.get(entityCreateButtonSelector).click({force: true});
    cy.getEntityCreateUpdateHeading('<%= entityClass %>');
    cy.get(entityCreateSaveButtonSelector).should('exist');
    cy.visit('/');
  });

  it('should load edit <%= entityClass %> page', () => {
    cy.server();
    cy.route('GET', '/<%= baseApi + entityApiUrl %>*').as('entitiesRequest');
    cy.visit('/');
    cy.clickOnEntityMenuItem('<%= entityStateName %>');
    cy.wait('@entitiesRequest');
    if (startingEntitiesCount > 0) {
      cy.get(entityEditButtonSelector).first().click({force: true});
      cy.getEntityCreateUpdateHeading('<%= entityClass %>');
      cy.get(entityCreateSaveButtonSelector).should('exist');
    }
    cy.visit('/');
  });

  <%= openBlockComment %>
  it('should create an instance of <%= entityClass %>', () => {
    cy.server();
    cy.route('GET', '/<%= baseApi + entityApiUrl %>*').as('entitiesRequest');
    cy.visit('/');
    cy.clickOnEntityMenuItem('<%= entityStateName %>');
    cy.wait('@entitiesRequest');
    cy.get(entityCreateButtonSelector).click({force: true});
    cy.getEntityCreateUpdateHeading('<%= entityClass %>');
    const randomText = 'text' + Math.floor(Math.random() * 1000) + 1;

    <%_ fields.forEach((field) => {
      const fieldName = field.fieldName;
      const fieldNameCapitalized = field.fieldNameCapitalized;
      const fieldType = field.fieldType;
      const fieldTypeBlobContent = field.fieldTypeBlobContent;
      const fieldIsEnum = field.fieldIsEnum;
    _%>
    <%_ if (['Integer', 'Long', 'Float', 'Double', 'BigDecimal'].includes(fieldType)) { _%>
    cy.setFieldNumberOfEntity('<%= fieldName %>', 5).should('have.value', '5');

    <%_ } else if (fieldType === 'LocalDate') { _%>
    cy.setFieldLocalDateOfEntity('<%= fieldName %>', '2001-01-01').should('have.value', '2001-01-01');

    <%_ } else if (['Instant', 'ZonedDateTime'].includes(fieldType)) { _%>
    cy.setFieldTimestampOfEntity('<%= fieldName %>', '2001-01-01T02:30').invoke('val').should('equal', '2001-01-01T02:30');

    <%_ } else if (fieldType === 'Duration') { _%>
    cy.setFieldDurationOfEntity('<%= fieldName %>', 'PT12S').should('have.value', '12');

    <%_ } else if (fieldType === 'Boolean') { _%>
    cy.get(`[data-cy="<%= fieldName %>"]`).should('not.be.checked');
    cy.setFieldBooleanOfEntity('<%= fieldName %>').should('be.checked');

    <%_ } else if (['byte[]', 'ByteBuffer'].includes(fieldType) && fieldTypeBlobContent === 'text') { _%>
    cy.setFieldTextAsBytesOfEntity('<%= fieldName %>', randomText).invoke('val').should('match', new RegExp(randomText));

    <%_ } else if (['byte[]', 'ByteBuffer'].includes(fieldType)) { _%>
    cy.setFieldImageAsBytesOfEntity('<%= fieldName %>', 'integration-test.png', 'image/png');

    <%_ } else if (fieldIsEnum) { _%>
    cy.setFieldEnumToLastOfEntity('<%= fieldName %>');

    <%_ } else if (fieldType === 'UUID'){ _%>
    cy.setFieldUuidOfEntity('<%= fieldName %>', '64c99148-3908-465d-8c4a-e510e3ade974').invoke('val').should('match', /64c99148-3908-465d-8c4a-e510e3ade974/);

    <%_ } else if(fieldType === 'String' && fieldName.toLowerCase().includes('number')) { _%>
    cy.setFieldNumberAsStringOfEntity('<%= fieldName %>', '5').should('have.value', '5');

    <%_ } else { _%>
    cy.setFieldTextAsBytesOfEntity('<%= fieldName %>', randomText).invoke('val').should('match', new RegExp(randomText));

    <%_ } _%>
    <%_ }); _%>
    <%_ relationships.forEach((relationship) => {
      const relationshipType = relationship.relationshipType;
      const ownerSide = relationship.ownerSide;
      const relationshipName = relationship.relationshipName;
      const relationshipNameCapitalized = relationship.relationshipNameCapitalized;_%>
    <%_ if (relationshipType === 'many-to-one' || (relationshipType === 'one-to-one' && ownerSide === true)) { _%>
    cy.setFieldSelectToLastOfEntity('<%= relationshipName %>');
    <%_ } else if ((relationshipType === 'many-to-many' && ownerSide === true)) { _%>
    cy.setFieldSelectToLastOfEntity('<%= relationshipName %>');
    <%_ } _%>
    <%_ }); _%>

    cy.get(entityCreateSaveButtonSelector).click({force: true});
    cy.get(entityCreateSaveButtonSelector).should('not.exist');
    cy.get(entityTableSelector).should('have.lengthOf', startingEntitiesCount + 1);
    cy.visit('/');
  });
  <%= closeBlockComment %>

  <%= openBlockComment %>
  it('should delete last instance of <%= entityClass %>', () => {
    cy.server();
    cy.route('GET', '/<%= baseApi + entityApiUrl %>*').as('entitiesRequest');
    cy.route('DELETE', '/<%= baseApi + entityApiUrl %>/*').as('deleteEntityRequest');
    cy.visit('/');
    cy.clickOnEntityMenuItem('<%= entityStateName %>');
    cy.wait('@entitiesRequest').its('responseBody').then(array => {
      startingEntitiesCount = array.length;
      if (startingEntitiesCount > 0) {
        cy.get(entityTableSelector).should('have.lengthOf', startingEntitiesCount);
        cy.get(entityDeleteButtonSelector).last().click({force: true});
        cy.getEntityDeleteDialogHeading('<%= entityInstance %>').should('exist');
        cy.get(entityConfirmDeleteButtonSelector).click({force: true});
        cy.wait('@deleteEntityRequest');
        cy.get(entityTableSelector).should('have.lengthOf', startingEntitiesCount - 1);
      }
      cy.visit('/');
    });
  });
  <%= closeBlockComment %>
  <%_ } _%>
});
